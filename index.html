<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!-- <META HTTP-EQUIV="pragma" CONTENT="no-cache"> 
        <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
        <META HTTP-EQUIV="expires" CONTENT="0"> -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <title>待遇资格认证</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body id="bady">
        <object classid="clsid:3FD70033-70C9-465C-BA40-EB358BF4E148" width="1" height="1" id="myActiveObj">
            </object>
    <div class="pc-box">
        <!-- 提示 -->
        <div class="isIe">
            <div class="pc-isIe_title ">请使用IE(IE8及以上版本)浏览器打开</div>
            <div class="pc-isIe_esc">取消认证</div>
        </div>
        <div class="authCertQuery">
            <div class="pc-isIe_title ">网络超时，请稍后再试</div>
            <div class="pc-isIe_esc">取消认证</div>
        </div>
        <div class="Jurisdiction">
            <div class="pc-isIe_title ">该渠道无权调用此服务！</div>
            <div class="pc-isIe_esc">取消认证</div>
        </div>
        <!-- 相机 -->
        <!-- <object classid="clsid:3FD70033-70C9-465C-BA40-EB358BF4E148" width="1" height="1" id="myActiveObj" act1n='update'></object> -->

    <!-- 第二页 -->
    <div class="pc-box_mian" id="two">
            <div class="two-box_mian_top">您将使用 PC 电脑进行业务办理， 请详细阅读并注意如下事项:</div>
            <div class="two-box_mian_middle">
                <p>进行人脸识别时， 请保持网络连接</p>
                <p>如出现页面不适配，请设置显示器分辨率为100%</p>
            </div>
            <div class="two-box_mian_bottom">
                <div class="box-mian_bottom_first">
                    <div class="box-bottom_img"></div>
                    <div class="box-bottom_text">请保持五官露出无遮挡</div>
                </div>
                <div class="box-mian_bottom_scond">
                    <div class="box-bottom_img"></div>
                    <div class="box-bottom_text">请保持人脸在采集框内</div>
                </div>
                <div class="box-mian_bottom_three">
                    <div class="box-bottom_img"></div>
                    <div class="box-bottom_text">请保持光线合适人脸清晰</div>
                </div>
            </div>
            <div class="pc-box_mian_button handle" id="button2">我已记住， 进入录制(3s)</div>

            <div class="pc-camera">
                <div class="pc-camera_close"></div>
                <div class="pc-tips_title">消息提醒</div>
                <div class="pc-tips_text"></div>
                <div class="pc-tips_bottom"></div>
                    <div class="pc-camera_cancel_sure handle">确定</div>
            </div>
    </div>
    <!-- loading -->
    <div class="pc-box_mian" id="loading">
        <div class="loading-img"><img src="./images/pc_loading_icon.gif" alt=""></div>
        <div class="loading-text">验证中...</div>
    </div>

    <!-- <div class="pc-box_mian pc-status_mian">
        <div class="pc-box_mian_success"></div>
        <div class="pc-box_mian_middle">认证成功</div>
        <div class="pc-box_mian_button">完成</div>
    </div> -->

    <div class="pc-box_mian" id="error1">
            <div class="fail-box_mian_top"></div>
            <div class="fail-box_mian_middle">
                <p>认证失败</p>
                <div class="errorMsg"></div>
            </div>
            <div class="fail-box_mian_button again handle" >重新认证</div>
            <div class="fail-box_mian_signOut handle">退出认证</div>
        </div>
    </div>

    <div class="pc-box_mian" id="error2">
        <div class="error-box_mian_top"></div>
        <div class="fail-box_mian_middle">
            <p>检测失败</p>
            <div class="errorText"></div>
        </div>
        <div class="fail-box_mian_button again handle">重新认证</div>
        <div class="fail-box_mian_signOut handle">退出认证</div>
    </div>

    <!-- 第一页 -->
    <div class="pc-box_mian" id="one">
            <div class="pc-box_mian_top"></div>
            <div class="pc-box_mian_middle">
                <p>请进行人脸识别身份认证 </p>
                <p>确保本人操作</p>
            </div>
            <div class="pc-box_mian_bottom handle">
                <input type="checkbox"  name="killOrder" value="0"id="input1" autocomplete="off" />
                <label for="killOrder2">阅读并同意<span id="agree">《人脸识别认证服务须知》</span></label>
            </div>
            <div class="pc-box_mian_button" id="button1">开始认证</div>

            <!-- 提示下载插件 -->
            <div class="pc-tips">
                <div class="pc-tips_close"></div>
                <div class="pc-tips_title">消息提醒</div>
                <div class="pc-tips_text versionControlText"></div>
                <div class="pc-tips_bottom"></div>
                    <div class="pc-tips_cancel handle">取消认证</div>
                    <!-- <div class="pc-tips_button handle"><a href="js/facedetect.msi">下载控件</a></div> -->
                    <!-- <div class="pc-tips_button handle"></div>   -->
                    <!-- <div class="pc-tips_button handle"><a href="js/FaceDetectV1.0.1_OCX.exe">下载控件</a></div> -->
                    <div class="pc-tips_button handle"><a href="javascript:;void">下载控件</a></div>
            </div>

                <div class="pc-camera">
                    <div class="pc-camera_close"></div>
                    <div class="pc-tips_title">消息提醒</div>
                    <div class="pc-tips_text"></div>
                    <div class="pc-tips_bottom"></div>
                        <div class="pc-camera_cancel handle">确定</div>
                </div>

            </div>


        <!-- </div> -->
    </div>

    <div class="pc-box_mian" id="loading1">
        <div class="loading-img"><img src="./images/pc_loading_icon.gif" alt=""></div>
        <!-- <div class="loading-text">...</div> -->
    </div>
    
</div>
</body>

<script type="text/javascript" src="js/jquery.min.js" charset="utf-8" ></script>
<script src="js/jquery.xdomainrequest.min.js"></script>
<script src="js/json2.js"></script>
<script>
    jQuery.support.cors = true
    var getStatus
    var postStat
    var authCertQueryParams
    // var authPersonParam
    // 是否拦截
    // console.log(navigator.userAgent, 'navigator.userAgent')
    // console.log(window.ActiveXObject, 'window.ActiveXObject')
    function IEVersion() {
    var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串  
    var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器  
    var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器  
    var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
    if(isIE) {
        var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
        reIE.test(userAgent);
        var fIEVersion = parseFloat(RegExp["$1"]);
        if(fIEVersion == 7) {
            return 7;
        } else if(fIEVersion == 8) {
            return 8;
        } else if(fIEVersion == 9) {
            return 9;
        } else if(fIEVersion == 10) {
            return 10;
        } else {
            return 6;//IE版本<=7
        }   
    } else if(isEdge) {
        return 'edge';//edge
    } else if(isIE11) {
        return 11; //IE11  
    }else{
        return false;//不是ie浏览器
    }
}
// 判断姓名身份证 是否一致
    function authPerson() {
            try {
                $.ajax({
                    type: 'POST',
                    // url: 'http://39.105.151.133/ecardapi/ecard/v1/auth/person',
                    // url: 'https://test-ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/person',
                    url: 'https://ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/person',
                    timeout : 120000, 
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json',
                    data: JSON.stringify(getStatus),
                    success: function (data) {
                        $('#loading1').hide()
                        if (data.msgCode === '000000') {
                            if (window.ActiveXObject !== undefined) {
                                if (IEVersion() == false) {
                                    $('.isIe').show()
                                    $('#one').hide()
                                    $('#loading1').hide()
                                    return
                                }
                                $('.isIe').hide()
                                $('#one').show()
                            } else {
                                $('.isIe').show()
                                $('#one').hide()
                                $('#loading1').hide()
                            }
                        } else if (data.msgCode === '600749') {
                            window.location.href= './index4.html'
                        } else {
                            $('#one').hide()
                            $('.authCertQuery').show()
                        }
                    },
                    error: function (e) {
                        // window.location.href= './index4.html'
                    }
                })
            } catch (error) {
                console.log(error, 'auth/person出错')
            }
    }
    function getStatusFun() {
        try {
            $.ajax({
                type: 'POST',
                // url: 'http://39.105.151.133/ecardapi/ecard/v1/attack/getStatus',
                // url: 'https://test-ssc.mohrss.gov.cn/ecardapi/ecard/v1/attack/getStatus',
                url: 'https://ssc.mohrss.gov.cn/ecardapi/ecard/v1/attack/getStatus',
                timeout : 120000, 
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data: JSON.stringify(getStatus),
                success: function (data) {
                    // if ()
                    if (data.result.status == '1') {
                        $('#two').show()
                        $('.pc-camera').show()
                        $('.pc-tips_text').text('检测到您有多次疑似攻击行为，请于24小时后重试')
                        return false
                    }
                    SetCamera()
                    return
                },
                error: function (e) {
                    SetCamera()
                    return
                }
            })
        } catch (error) {
            SetCamera()
            return
        }
    }
    function record() {
        try {
            $.ajax({
                type: 'POST',
                // url: 'http://39.105.151.133/ecardapi/ecard/v1/attack/record',
                // url: 'https://test-ssc.mohrss.gov.cn/ecardapi/ecard/v1/attack/record',
                url: 'https://ssc.mohrss.gov.cn/ecardapi/ecard/v1/attack/record',
                timeout : 120000, 
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data: JSON.stringify(getStatus),
                success: function (data) {
                },
                error: function (e) {
                    return true
                }
            })
        } catch (error) {
            return true
        }
        return true
    }
    // 埋点
    function postStat() {
        try {
            $.ajax({
                type: 'POST',
                url: 'http://39.105.151.133/logCollect/log/collect/print/local',
                // url: 'https://test-ssc.mohrss.gov.cn/logCollect/log/collect/print/local',
                // url: 'https://ssc.mohrss.gov.cn/logCollect/log/collect/print/local',
                timeout : 120000, 
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data: JSON.stringify(postStat),
                success: function (data) {
                },
                error: function (e) {
                    return true
                }
            })
        } catch (error) {
            return true
        }
        return true
    }

    // function SetCamera() {
    //     var index = 0;
    //     var result = myActiveObj.CheckCamera(index);
    //     // document.getElementById("data1").innerHTML = result;
    //     alert(result)
    //     console.log(result, 'result')
    //     //var index = 0;    
    //     //myActiveObj.SetCamera(index); 
    // }
    // SetCamera()
        // 判断摄像头是否打开
    // function isCamera () {
    //         var indexPhoto = 0
    //         var results = myActiveObj.CheckCamera(indexPhoto)
    //         if (results == '-1') {
    //             return false
    //         }
    //         return true
    //     }
        var versionNum

        // 判断系统版本和摄像头是否开启
        function versionControl (num) {
            var index = 0;
            try {
                var result = myActiveObj.CheckCamera(index);
                result = JSON.parse(result)
                versionNum = '1'
                versionNum = result.version
                console.log(versionNum, '版本号')
                if (num == '1') {
                    return
                }
                if (result.code == '0') {
                    return true
                }
                if (result.code == '9003') {
                    $('.pc-camera').show()
                    $('.pc-tips_text').text('摄像头分辨率过低，无法使用')
                    return false
                }
                if (result.code == '9001') { // 操作系统不支持 或 内存不足4G
                    $('.pc-camera').show()
                    $('.pc-tips_text').text('系统配置过低，暂不支持认证')
                    return false
                }
                if (result.code == '9002') {
                    $('.pc-camera').show()
                    $('.pc-tips_text').text('无法打开摄像头，请检查摄像头是否可用')
                    return false
                }
            } catch (e) {
                versionNum = '1'
                console.log('v检测插件失败')
                if (num == '1') {
                    return
                }
                $('.pc-camera').show()
                $('.pc-tips_text').text('无法打开摄像头，请检查摄像头是否可用')
                return false;
            }
            if (num == '1') {
                    return
                }
            $('.pc-camera').show()
            $('.pc-tips_text').text('无法打开摄像头，请检查摄像头是否可用')
            return false
        }
        versionControl('1')
        // 云端检测
        function checkPic(jsonStr) {
            var activex = document.getElementById('myActiveObj');
            
            var data = jsonStr
            if(data.code == '0') {
                setTimeout(function() {
                    var res = activex.GetMsg && activex.GetMsg() || '{}';
                    var checkData = JSON.parse(res);
                    if (checkData.code == '0') {
                        if (checkData.data.is_alive == true) {
                            params = {
                            'channelNo': channelNo,
                            'aac002': aac002,
                            'aac003': aac003,
                            'aac201': checkData.image,
                            'aae586': 'jpeg',
                            'businessType': 'provideQualificateCert',
                            'certType': '4',
                            'equipmentInfo': 'pc'
                            }
                            verification()
                            return
                        }
                        $('#error2').show()
                        $('.errorText').text('认证中断，请重试')
                        return
                    }

                    if (checkData.code == '9007') {
                        $('#error2').show()
                        $('.errorText').text('认证中断，请重试')
                        return
                    }

                    if (checkData.code == '9008') {  // 攻击
                        $('#error2').show()
                        record()
                        $('.errorText').text('认证中断，请重试')
                        return
                    }

                    if (checkData.code == '9015') {
                        $('#error2').show()
                        $('.errorText').text('网络异常，请稍后重试')
                        return
                    }

                    if (checkData.code == '9014') {
                        $('#error2').show()
                        $('.errorText').text('未获取到您的照片信息，无法支持您本次认证')
                        return
                    }

                    if (checkData.code == '40002') {
                        $('#error2').show()
                        $('.errorText').text('人脸检测未通过，请重试')
                        return
                    }

                    $('#error2').show()
                    console.log('GetMsg方法提示异常')
                    $('.errorText').text('认证中断，请重试')
                    return
                    
                // setTimeout (function () {
                //     $('#loading').show()
                //     verification()
                }, 0)
            }
        }
        function authCertQuery () {
        $.ajax({
            type: 'POST',
            // url: 'http://39.105.151.133/portal/forward?service=/ecard/v1/auth/cert/query',
            // url: 'http://39.105.151.133/ecardapi/ecard/v1/auth/cert/query',
            // url: 'https://test-ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/cert/query',
            url: 'https://ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/cert/query',
            // headers: {
            //     'X-TOKEN': token
            // },
            timeout : 120000, 
            // contentType: "text/plain",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: JSON.stringify(authCertQueryParams),
            success: function (data) {
                // $('#loading1').hide()
            if (data.msgCode === '000000') {
                authPerson()
                // $('#one').show()

                // 判断身份证和姓名是否一致
                // if (window.ActiveXObject !== undefined) {
                //     if (IEVersion() == false) {
                //         $('.isIe').show()
                //         $('#one').hide()
                //         $('#loading1').hide()
                //         return
                //     }
                //     $('.isIe').hide()
                //     $('#one').show()
                // } else {
                //     $('.isIe').show()
                //     $('#one').hide()
                //     $('#loading1').hide()
                // }
            } else if (data.msgCode === '700028'){
                // $('#one').show()
                window.location.href= './index3.html'
            } else if (data.msgCode === '700029'){
                // $('#one').show()
                window.location.href= './index2.html'
            } else {
                $('#one').hide()
                $('.authCertQuery').show()
            }
            },
            error: function (e) {
                $('#one').hide()
                $('.authCertQuery').show()
                $('#loading1').hide() 
            }
        })
    }
    // authCertQuery()
        
        // 获取签名串
        function getUrlParams () {
            var url = document.location.toString()
            var arrUrl = url.split('?')
            var str = arrUrl[1]
            return str
        }
        
        // 首页按钮颜色
        setTimeout(function () {
            if($("#input1").prop("checked")) {
                $('#button1').css('opacity', '1')
            } else {
                $('#button1').css('opacity', '.7')
            }
        } , 0)
        if($("#input1").prop("checked")) {
            $('#button1').css('opacity', '1')
        }

        $('.pc-tips').css('display','block')
        $('.pc-camera').css('display','block')
        $('.isIe').css('display','block')
        $('.authCertQuery').css('display','block')
        $('.Jurisdiction').css('display','block')
        $('#two').hide()
        $('.authCertQuery').hide()
        $('.Jurisdiction').hide()
        $('#loading').hide()
        // $('#loading').hide()
        $('#error1').hide()
        $('#error2').hide()
        $('.pc-tips').hide()
        $('.pc-camera').hide()

        // 获取
        var str = getUrlParams()
        // var str = '_api_timestamp=1561360340856&security=OKUlHrgafoamFCAagWZNlnUDN2kfi4OMJl83dZCqFeEK6h3sT5SyrfPYNOAR2yVc1IB9aqsOA69XYASftVoTA2zJS8iUhHYqYV0jdTElex4tdpRxkdB5z72RL2bdBiba5DTLAOZmADUGxJhCMi3GCegwzfwgHdvqPCPchCOlBIxMlAzPpZWiXafZ9IZFsj6N5FSdaZPZaoZcIbQdpByP9OR%2BLcaKFmOv%2BtTd0bie0mGpfLIYolzXnI0ZFGHJ8Rv0yDME7xN%2BT8k4mPgve%2B%2B8PIwePMlhVqIiMdyyPWXqg%2BO7CAeSxIkZhd5QY%2BNbcfBOBCq9gwXj69s%2FbRSMA3YpVsMB8dentWrurMB7ZMamMBAXOYRn6BrUuyUUNB0KPlPiClL921Mti%2BvE%2FqNauCSTcVHRirk%2FSFq4QNyQmvazEiM%3D&_api_name=get_token&api_access_key=88b925edca3945cb8d6525481058bcd6&_api_signature=lvyWWzul351YKuJpW1mrL9tQamU%3D&return_url=https%3A%2F%2Fwww.baidu.com&_api_version=1.0.0&_api_access_key=88b925edca3945cb8d6525481058bcd6'
        // var url = "https://test-ssc.mohrss.gov.cn/api/token?" + str
        // var str = '_api_timestamp=1563761044630&security=1fe9fhRCLGwutTrrSc4Sgs3t3HNmmhVKLLEoc%2FW7lJ3GQIMankNvN5gyC7tH7koBIMrBkJtVctLndWoG9Ix24BtK8hdBCymlVqQ72OWoHXsOS2chLgD%2B4MuvaHCWLRPjXCfusNJBiQQ2a0%2BTOsQn5O1UsF3G41vCRQXg%2BvEoLfsaliqhhDZnNS12EL%2FcsFh8cHm8kntGFd35eAwck5RXgeFUI9%2BiV9xFEbfJ6lQRneI%3D&_api_name=get_token&api_access_key=88b925edca3945cb8d6525481058bcd6&_api_signature=tgmbxbnsy2QaPznZVdm3EPT%2FbN0%3D&return_url=https%3A%2F%2Fwww.baidu.com&_api_version=1.0.0&_api_access_key=88b925edca3945cb8d6525481058bcd6'
        var url = "https://ssc.mohrss.gov.cn/api/token?" + str
        // var url = "http://39.105.151.133/api/token?" + str
        var channelNo // 渠道号
        var aac003   // 身份证号
        var aac002  // 姓名
        var token
        // 提示是否是Ie浏览器
        $('.isIe').css('display', 'none')
        // if (window.ActiveXObject !== undefined) {
        //     $('.isIe').hide()
        //     $('#one').hide()
        //     $.getJSON(url).done(function(datas) {
        //         //  console.log(datas, 'ffff')
        //         if (datas.msgCode === '000000') {
        //         //  console.log(datas, 'ffff')
        //         token = datas.result.token
        //         aac002 = datas.result.aac002
        //         aac003 = datas.result.aac003
        //         channelNo = datas.result.channelNo
        //         authCertQueryParams = {
        //             'aac002': aac002,
        //             'aac003': aac003,
        //         }
        //         getStatus = {
        //             'aac002': aac002,
        //             // 'aac002': '210212199301295911',
        //             'aac003': aac003,
        //             // 'aac003': '张万明',
        //             'channelNo': channelNo
        //         }
        //         // getStatusFun()
        //         // record()
        //         authCertQuery()
        //         } else {
        //             $('.authCertQuery').show()
        //             $('#loading1').hide() 
        //         }
        //     });
        // } else {
        //     $('.isIe').show()
        //     $('#one').hide()
        //     $('#loading1').hide()
        // }

             $.getJSON(url).done(function(datas) {
                if (datas.msgCode === '000000') {
                token = datas.result.token
                aac002 = datas.result.aac002
                aac003 = datas.result.aac003
                channelNo = datas.result.channelNo
                authCertQueryParams = {
                    'aac002': aac002,
                    'aac003': aac003,
                }
                getStatus = {
                    'aac002': aac002,
                    'aac003': aac003,
                    'channelNo': channelNo
                }
                postStat = {
                    channelNo: channelNo,
                    signNo: '',
                    cardNumber: aac002,
                    event: 'PVLK29'
                }
                postStat()
                authCertQuery()
                } else {
                    $('.authCertQuery').show()
                    $('#loading1').hide()
                    $('#one').hide()
                }
            });
        // 获取摄像头位置大小
        var  width = window.screen.width
        var height = window.screen.height;
        if (window.devicePixelRatio) {
            width = window.screen.width * window.devicePixelRatio;
        }
        width = (width - 732) / 2
        height = (height - 554) / 2

        var isTIps = true // 是否需要进入提示页面
        var timer // 定时器
        var num // 提示页倒计时时间

        // 取消认证  完成按钮 
        $('.pc-tips_cancel').on('click', function () {
            // history.go(-1)
            //
            window.close()
        })
        $('.pc-camera_cancel').on('click', function () {
            // history.go(-1)
            //
            // window.close()
            $('.pc-camera').hide()
        })
        $('.pc-camera_cancel_sure').on('click', function () {
            $('.pc-camera').hide()
        })
        $('.pc-tips_close').on('click', function () {
            $('.pc-tips').hide()
        })
        $('.pc-camera_close').on('click', function () {
            $('.pc-camera').hide()
        })
        $('.pc-isIe_esc').on('click', function () {
            // history.go(-1)
            // 
            window.close()
        })
        $('.pc-tips_button').on('click', function () {
            window.location.href = './js/EsscFaceDetect.exe'
            if (checkPlugins()) {
                setTimeout (function () {
                    window.location.href = './update.html'
                }, 200)
            }

            $('.pc-tips').hide()
        })

        // 跳转协议页
        $('#agree').on('click', function () {
            window.open('./agreement.html'); 
        })


        // 开始认证接口
        $('#button1').on('click', function () {
            if($("#input1").get(0).checked) {
                // 判断是否安装插件
                if (checkPlugins()) {
                    if (versionNum == '1') { // 更新逻辑
                        $('.pc-camera').show()
                        $('.pc-tips_text').text('请刷新浏览后再进入认证流程。')
                        return
                    }
                    if (versionNum !== '1.0.2') { // 更新逻辑
                        $('.pc-tips').show()
                        $('.versionControlText').text('检测到新的人脸采集控件，请下载安装后再进入认证流程。')
                        return
                    }
                    if (versionControl()) {  // 修改判断相机的方法
                        $('.pc-camera').hide()
                        $('.pc-tips').hide()
                        if (isTIps) {
                            $('#one').hide()
                            $('#two').show()
                            num = 2
                            timer = setInterval (function() {
                                isTIps =  false
                                if (num > 0) {
                                    $('#button2').text('我已记住， 进入录制(' + num + 's)')
                                    num --
                                } else {
                                    $('#button2').text('我已记住， 进入录制').addClass("colorButton")
                                }
                            }, 1000)
                        } else {
                            // SetCamera()
                            getStatusFun()
                        }
                    } else {
                        return
                        $('.pc-camera').show()
                        $('.pc-tips_text').text('无法打开摄像头，请检查摄像头是否可用')
                    }
                
                } else {
                    $('.pc-tips').show()
                    $('.versionControlText').text('请下载并安装人脸采集控件，安装完成后刷新浏览器，以确保正常进入认证流程。')
                    return
                }
            }
        })

        // 重新检测
        $(".again").on("click", function () {
            try {
                $('#error1').hide()
                $('#error2').hide()
            } catch (error) {
                console.log('重新检测')
            }
            getStatusFun()
        })

        // 退出登陆
        $('.fail-box_mian_signOut').on("click", function () {
            // history.go(-1)
            // 
            window.close()
        })

        // 我已记住， 进入录制 按钮
        var params
        $('#button2').on('click', function () {
            if (num === 0) {
                $('#two').hide()
                setTimeout (function () {
                    // SetCamera()
                    getStatusFun()
                }, 0)
            }
        })

        var pic // 图片信
        // 勾选协议
        $("#input1").on("click", function () {
            if ($("#input1").get(0).checked) {
                $('#button1').css('opacity', '1').on('click', function () {
                })
            } else {
                $('#button1').css('opacity', '.7');
            }
        })
        // 接口校验人脸
        var codeText // 提示信息
        var code     // 提示code
    function verification () {
        $.ajax({
            type: 'POST',
            // url: 'http://39.105.151.133/ecardapi/ecard/v1/auth/face',
            url: 'https://ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/face',
            // url: 'https://test-ssc.mohrss.gov.cn/ecardapi/ecard/v1/auth/face',
            // headers: {
            //     'X-TOKEN': token
            // },
            timeout : 120000, 
            // contentType: "text/plain",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: JSON.stringify(params),
            success: function (data) {
            if (data.msgCode === '600725') {
                $('.Jurisdiction').show()
                $('#loading').hide()
                return
            }
            if (data.msgCode === '000000') {
                window.location.href= './index1.html'
            } else {
                console.log(data.msg, '人脸异常')
                code = data.msgCode
                if (!code) {
                    codeText = '认证中断，请重试'
                } else if (code === '600707' || code === '600708' || code === '600752') {
                    codeText = '获取用户信息失败，请重试'
                } else if (code === '700003' || code === '700004') {
                    codeText = '当前服务异常，请重试'
                } else {
                    codeText = '您未通过待遇资格认证，请重试'
                }
                $('#loading').hide()
                $('#error1').show()
                $('.errorMsg').text(codeText)
            }
            },
            error: function (e) {
                console.log(e.responseText, '人脸异常')
            if (e.responseText) {
                var fail = e.responseText
                code = JSON.parse(fail).resultCode
                if (!code) {
                    codeText = '认证中断，请重试'
                } else if (code === '600707' || code === '600708' || code === '600752') {
                    codeText = '获取用户信息失败，请重试'
                } else if (code === '700003' || code === '700004') {
                    codeText = '当前服务异常，请重试'
                } else {
                    codeText = '您未通过待遇资格认证，请重试'
                }
            } else {
                codeText = '认证中断，请重试'
            }
            
                $('.errorMsg').text(codeText)
                $('#loading').hide()
                $('#error1').show()
            }
        })
    }   
        // 关闭摄像头
        function doClose()
        {
            var delayss = 1;
        var result= myActiveObj.doConsole(delayss); 
        }
        //  打开摄像头
        function SetCamera (num) {
            var MyClock = document.getElementById("myActiveObj");
            try {
                pic = MyClock.detectWithPosition(width,150,732,554,3);
            } catch (error) {
                alert('0000')
            }
            pic = JSON.parse(pic)
            console.log(pic, 'llllll')
            if (pic.code == '0') {
                $('#loading').show()
                checkPic(pic)
                return
            }
            if (pic.code === '9013') {
                $('#two').show()
                $('.pc-camera').show()
                $('.pc-tips_text').text('当前网站未经过授权')
            } else if (pic.code === '9005') {
                $('#error2').show()
                $('.errorText').text('发生错误，请稍后重试')
            } else if (pic.code === '9006') {
                $('#two').show()
                $('.pc-camera').show()
                $('.pc-tips_text').text('打开摄像头失败')
            } else if (pic.code === '9009') {  // 攻击
                $('#error2').show()
                record()
                $('.errorText').text('请根据文字和动画引导完成指定动作')
            } else if (pic.code === '9010') {
                $('#error2').show()
                $('.errorText').text('认证超时，请重试')
            } else if (pic.code === '9011') {
                $('#error2').show()
                $('.errorText').text('认证中断，请重试')
            } else if (pic.code === '9012') {
                $('#error2').show()
                $('.errorText').text('认证中断，请重试')
            } else {
                // params = {
                //     'channelNo': channelNo,
                //     'aac002': aac002,
                //     'aac003': aac003,
                //     'aac201': pic,
                //     'aae586': 'jpeg',
                //     'businessType': 'provideQualificateCert'
                // }
                // setTimeout (function () {
                //     $('#loading').show()
                //     verification()
                // }, 1000)

                // 
                // $('#loading').show()
                // check(pic)

                $('#error2').show()
                $('.errorText').text(pic.msg)
            }
        }

        // 检测插件是否安装
        function checkPlugins() {
            var activexObjectName = "F_GETFACEDETECTA.f_getFaceDetectACtrl.1";
            try {
                var axobj = eval("new ActiveXObject(activexObjectName);");
                // 将对象转化为布尔类型
                return axobj ? true : false;
            } catch (e) {
                console.log('检测插件失败')
                return false;
            }
            return false;
        }

</script>
</html>